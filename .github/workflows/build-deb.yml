name: Build DEB Package

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'kylin-software-installer/**'
      - '.github/workflows/build-deb.yml'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential qt5-qmake qtbase5-dev qttools5-dev-tools libssl-dev libcurl4-openssl-dev

      - name: Create build directory
        working-directory: ./kylin-software-installer
        run: mkdir -p build

      - name: Configure CMake
        working-directory: ./kylin-software-installer/build
        run: cmake ..

      - name: Build
        working-directory: ./kylin-software-installer/build
        run: make -j$(nproc)

      - name: Create DEB package
        working-directory: ./kylin-software-installer/build
        run: |
          mkdir -p /tmp/deb-package
          make install DESTDIR=/tmp/deb-package
          mkdir -p /tmp/deb-package/DEBIAN
          cat > /tmp/deb-package/DEBIAN/control << 'EOF'
          Package: kylin-software-installer
          Version: 1.0.0
          Architecture: arm64
          Maintainer: Kylin Team <support@kylin.com>
          Description: Kylin Software Installer for offline software installation
           A Qt-based application for installing software packages on Kylin systems
           with automatic dependency resolution and installation management.
          Depends: libc6, libqt5core5a, libqt5gui5, libqt5widgets5
          EOF
          dpkg-deb --build /tmp/deb-package kylin-software-installer-1.0.0-arm64.deb

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: deb-package
          path: kylin-software-installer/build/kylin-software-installer-1.0.0-arm64.deb
          retention-days: 30

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            kylin-software-installer/build/kylin-software-installer-1.0.0-arm64.deb
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: false
          prerelease: false
