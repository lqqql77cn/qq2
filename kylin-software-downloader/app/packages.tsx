import { ScrollView, Text, View, TextInput, TouchableOpacity, Pressable, FlatList } from "react-native";
import { useRouter } from "expo-router";
import { ScreenContainer } from "@/components/screen-container";
import { useDownload } from "@/lib/contexts/download-context";
import { useColors } from "@/hooks/use-colors";
import { MaterialIcons } from "@expo/vector-icons";
import { useState, useMemo } from "react";

// Mock data for packages - in real app, this would come from API\nconst MOCK_PACKAGES = [\n  {\n    id: \"pkg_1\",\n    name: \"curl\",\n    version: \"7.68.0\",\n    size: 1024 * 512, // 512 KB\n    description: \"Command line tool for transferring data with URLs\",\n    dependencies: [\"libcurl4\"],\n    sourceId: \"source_1\",\n  },\n  {\n    id: \"pkg_2\",\n    name: \"git\",\n    version: \"2.34.1\",\n    size: 1024 * 1024 * 5, // 5 MB\n    description: \"Fast, scalable, distributed revision control system\",\n    dependencies: [\"perl\", \"openssh-client\"],\n    sourceId: \"source_1\",\n  },\n  {\n    id: \"pkg_3\",\n    name: \"python3\",\n    version: \"3.9.2\",\n    size: 1024 * 1024 * 15, // 15 MB\n    description: \"Interactive high-level object-oriented language\",\n    dependencies: [\"libpython3.9\"],\n    sourceId: \"source_1\",\n  },\n  {\n    id: \"pkg_4\",\n    name: \"nodejs\",\n    version: \"14.19.0\",\n    size: 1024 * 1024 * 20, // 20 MB\n    description: \"JavaScript runtime built on Chrome's V8 JavaScript engine\",\n    dependencies: [\"libc6\"],\n    sourceId: \"source_1\",\n  },\n];\n\nexport default function PackagesScreen() {\n  const router = useRouter();\n  const colors = useColors();\n  const { state, selectPackage, deselectPackage, selectAllPackages, deselectAllPackages } = useDownload();\n  const [searchText, setSearchText] = useState(\"\");\n  const [expandedId, setExpandedId] = useState<string | null>(null);\n\n  const filteredPackages = useMemo(() => {\n    if (!searchText.trim()) return MOCK_PACKAGES;\n    const lowerSearch = searchText.toLowerCase();\n    return MOCK_PACKAGES.filter(\n      (pkg) => pkg.name.toLowerCase().includes(lowerSearch) || pkg.description.toLowerCase().includes(lowerSearch)\n    );\n  }, [searchText]);\n\n  const handleSelectAll = () => {\n    if (state.selectedPackages.length === filteredPackages.length) {\n      deselectAllPackages();\n    } else {\n      selectAllPackages(filteredPackages.map((p) => p.id));\n    }\n  };\n\n  const getTotalSize = () => {\n    return MOCK_PACKAGES\n      .filter((p) => state.selectedPackages.includes(p.id))\n      .reduce((sum, p) => sum + p.size, 0);\n  };\n\n  const formatSize = (bytes: number) => {\n    if (bytes === 0) return \"0 B\";\n    const k = 1024;\n    const sizes = [\"B\", \"KB\", \"MB\", \"GB\"];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + \" \" + sizes[i];\n  };\n\n  const renderPackageItem = ({ item }: { item: (typeof MOCK_PACKAGES)[0] }) => {\n    const isSelected = state.selectedPackages.includes(item.id);\n    const isExpanded = expandedId === item.id;\n\n    return (\n      <View className=\"bg-surface rounded-lg border border-border overflow-hidden mb-3\">\n        <Pressable\n          onPress={() => {\n            if (isSelected) {\n              deselectPackage(item.id);\n            } else {\n              selectPackage(item.id);\n            }\n          }}\n          style={({ pressed }) => [{ opacity: pressed ? 0.7 : 1 }]}\n        >\n          <View className=\"flex-row items-center gap-3 p-4\">\n            <View\n              className={`w-6 h-6 rounded border-2 items-center justify-center ${\n                isSelected ? \"bg-primary border-primary\" : \"border-border\"\n              }`}\n            >\n              {isSelected && <MaterialIcons name=\"check\" size={16} color=\"white\" />}\n            </View>\n            <View className=\"flex-1\">\n              <View className=\"flex-row items-center gap-2 mb-1\">\n                <Text className=\"text-base font-semibold text-foreground flex-1\">{item.name}</Text>\n                <Text className=\"text-xs font-medium text-muted\">{item.version}</Text>\n              </View>\n              <Text className=\"text-xs text-muted\">{formatSize(item.size)}</Text>\n            </View>\n            <Pressable\n              onPress={() => setExpandedId(isExpanded ? null : item.id)}\n              style={({ pressed }) => [{ opacity: pressed ? 0.7 : 1 }]}\n            >\n              <MaterialIcons\n                name={isExpanded ? \"expand-less\" : \"expand-more\"}\n                size={20}\n                color={colors.muted}\n              />\n            </Pressable>\n          </View>\n        </Pressable>\n\n        {/* Expanded Details */}\n        {isExpanded && (\n          <View className=\"bg-surface bg-opacity-50 border-t border-border p-4 gap-2\">\n            <Text className=\"text-xs font-semibold text-muted\">描述</Text>\n            <Text className=\"text-sm text-foreground leading-relaxed\">{item.description}</Text>\n            {item.dependencies.length > 0 && (\n              <>\n                <Text className=\"text-xs font-semibold text-muted mt-2\">依赖 ({item.dependencies.length})</Text>\n                <View className=\"flex-row flex-wrap gap-2\">\n                  {item.dependencies.map((dep) => (\n                    <View key={dep} className=\"bg-primary bg-opacity-10 rounded-full px-3 py-1\">\n                      <Text className=\"text-xs font-medium text-primary\">{dep}</Text>\n                    </View>\n                  ))}\n                </View>\n              </>\n            )}\n          </View>\n        )}\n      </View>\n    );\n  };\n\n  return (\n    <ScreenContainer className=\"p-4\">\n      <ScrollView contentContainerStyle={{ flexGrow: 1 }} showsVerticalScrollIndicator={false}>\n        <View className=\"gap-4\">\n          {/* Header */}\n          <View className=\"gap-2 mb-2\">\n            <Text className=\"text-2xl font-bold text-foreground\">软件清单</Text>\n            <Text className=\"text-sm text-muted\">\n              已选择 {state.selectedPackages.length} 个软件 · {formatSize(getTotalSize())}\n            </Text>\n          </View>\n\n          {/* Search Bar */}\n          <View className=\"flex-row items-center bg-surface border border-border rounded-lg px-4 gap-2\">\n            <MaterialIcons name=\"search\" size={20} color={colors.muted} />\n            <TextInput\n              value={searchText}\n              onChangeText={setSearchText}\n              placeholder=\"搜索软件包...\"\n              placeholderTextColor={colors.muted}\n              className=\"flex-1 py-3 text-foreground\"\n            />\n            {searchText.length > 0 && (\n              <Pressable onPress={() => setSearchText(\"\")}\n                style={({ pressed }) => [{ opacity: pressed ? 0.7 : 1 }]}\n              >\n                <MaterialIcons name=\"close\" size={20} color={colors.muted} />\n              </Pressable>\n            )}\n          </View>\n\n          {/* Select All / Clear All */}\n          <View className=\"flex-row gap-2\">\n            <TouchableOpacity\n              className=\"flex-1 bg-primary bg-opacity-10 rounded-lg py-2 px-3 flex-row items-center justify-center gap-2\"\n              onPress={handleSelectAll}\n            >\n              <MaterialIcons\n                name={state.selectedPackages.length === filteredPackages.length ? \"deselect\" : \"select-all\"}\n                size={18}\n                color=\"#0066CC\"\n              />\n              <Text className=\"text-sm font-semibold text-primary\">\n                {state.selectedPackages.length === filteredPackages.length ? \"全不选\" : \"全选\"}\n              </Text>\n            </TouchableOpacity>\n            {state.selectedPackages.length > 0 && (\n              <TouchableOpacity\n                className=\"flex-1 bg-error bg-opacity-10 rounded-lg py-2 px-3 flex-row items-center justify-center gap-2\"\n                onPress={() => deselectAllPackages()}\n              >\n                <MaterialIcons name=\"clear\" size={18} color=\"#EF4444\" />\n                <Text className=\"text-sm font-semibold text-error\">清空</Text>\n              </TouchableOpacity>\n            )}\n          </View>\n\n          {/* Packages List */}\n          {filteredPackages.length === 0 ? (\n            <View className=\"items-center justify-center py-12 gap-3\">\n              <MaterialIcons name=\"package\" size={48} color={colors.muted} />\n              <Text className=\"text-base font-semibold text-foreground\">未找到软件包</Text>\n              <Text className=\"text-sm text-muted text-center\">请尝试其他搜索条件</Text>\n            </View>\n          ) : (\n            <FlatList\n              data={filteredPackages}\n              renderItem={renderPackageItem}\n              keyExtractor={(item) => item.id}\n              scrollEnabled={false}\n            />\n          )}\n        </View>\n      </ScrollView>\n    </ScreenContainer>\n  );\n}\n
